<?php
/**
 * Frontend Students Quiz Attempts
 *
 * @package Tutor\Templates
 * @subpackage Dashboard
 * @author Themeum <support@themeum.com>
 * @link https://themeum.com
 * @since 1.4.0
 */

use TUTOR\Input;
use Tutor\Models\QuizModel;


if ( isset( $_GET['view_quiz_attempt_id'] ) ) {
    // Load single attempt details if ID provided.
    include __DIR__ . '/quiz-attempts/quiz-reviews.php';
    return;
}

$item_per_page = tutor_utils()->get_option( 'pagination_per_page' );
$current_page  = max( 1, Input::get( 'current_page', 1, Input::TYPE_INT ) );
$offset        = ( $current_page - 1 ) * $item_per_page;

// Filter params.
$course_filter = Input::get( 'course-id', '' );
$order_filter  = Input::get( 'order', 'DESC' );
$date_filter   = Input::get( 'date', '' );
?>

<form method="post" action="<?php echo esc_url(admin_url('admin-post.php'));?>" style="display: inline;">
    <input type="hidden" name="action" value="download_quiz_attempts">
    <?php wp_nonce_field( 'download_quiz_attempts_action', 'download_quiz_attempts_nonce' ); ?>
    <button type="submit" style="background-color: #bc2605; color: #ffffff; border: 1px solid #bc2605; padding: 6px 15px; cursor: pointer; margin-right: 10px;">
        Download 
    </button>
</form>

<!-- Print Button -->
<button id="print-button" class="button" style="background-color: #bc2605; color: #ffffff; border: 1px solid #bc2605; padding: 6px 15px; cursor: pointer;">
    Print
</button>

<script>
document.getElementById('print-button').addEventListener('click', function() {
    window.print();
});
</script>

<?php
// Handle download action
add_action('admin_post_download_quiz_attempts', 'custom_handle_download_quiz_attempts');
add_action('admin_post_nopriv_download_quiz_attempts', 'custom_handle_download_quiz_attempts');

function custom_handle_download_quiz_attempts() {
    if ( ! isset( $_POST['download_quiz_attempts_nonce'] ) || ! wp_verify_nonce( $_POST['download_quiz_attempts_nonce'], 'download_quiz_attempts_action' ) ) {
        wp_die( 'Security check failed.' );
    }

    global $wpdb;

    // Query all quiz attempts data, sorted by score (from pass to fail)
    $quiz_attempts = $wpdb->get_results("
        SELECT *
        FROM {$wpdb->prefix}tutor_quiz_attempts
        ORDER BY score DESC
    ");

    if ($quiz_attempts) {
        $filename = 'quiz_attempts.csv';
        $csv_data = "User ID,Quiz ID,Attempt Date,Score\n";

        // Generate CSV data
        foreach ($quiz_attempts as $attempt) {
            $csv_data .= "{$attempt->user_id},{$attempt->quiz_id},{$attempt->attempt_date},{$attempt->score}\n";
        }

        // Set headers for file download
        header('Content-Type: text/csv');
        header('Content-Disposition: attachment; filename=' . $filename);

        // Output CSV data
        echo $csv_data;

        // Terminate script execution
        exit;
    } else {
        wp_die( 'No quiz attempts found.' );
    }
}

// Load filter template.
tutor_load_template_from_custom_path( tutor()->path . 'templates/dashboard/elements/filters.php' );

$course_id           = tutor_utils()->get_assigned_courses_ids_by_instructors();
$quiz_attempts       = QuizModel::get_quiz_attempts( $offset, $item_per_page, '', $course_filter, $date_filter, $order_filter, null, false, true );
$quiz_attempts_count = QuizModel::get_quiz_attempts( $offset, $item_per_page, '', $course_filter, $date_filter, $order_filter, null, true, true );

tutor_load_template_from_custom_path(
    tutor()->path . '/views/quiz/attempt-table.php',
    array(
        'attempt_list' => $quiz_attempts,
        'context'      => 'frontend-dashboard-students-attempts',
    )
);

$pagination_data = array(
    'total_items' => $quiz_attempts_count,
    'per_page'    => $item_per_page,
    'paged'       => $current_page,
);
if ( $quiz_attempts_count > $item_per_page ) {
    $pagination_template_frontend = tutor()->path . 'templates/dashboard/elements/pagination.php';
    tutor_load_template_from_custom_path( $pagination_template_frontend, $pagination_data );
}
?>
