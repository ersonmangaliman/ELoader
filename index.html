<?php
/**
 * Frontend Students Quiz Attempts
 *
 * @package Tutor\Templates
 * @subpackage Dashboard
 * @author Themeum <support@themeum.com>
 * @link https://themeum.com
 * @since 1.4.0
 */

use TUTOR\Input;
use Tutor\Models\QuizModel;

// Filter params.
$course_id     = 1; // Define your course ID here.
$order_filter  = 'DESC';
$start_date    = '2024-01-01';
$end_date      = '2024-12-31';
$quiz_attempts_count = 10;

// Query quiz attempts data
global $wpdb;
$quiz_attempts = $wpdb->get_results( $wpdb->prepare( "
    SELECT *
    FROM {$wpdb->prefix}tutor_quiz_attempts
    WHERE course_id = %d
    AND attempt_date BETWEEN %s AND %s
    ORDER BY attempt_date %s
    LIMIT %d
", $course_id, $start_date, $end_date, $order_filter, $quiz_attempts_count ) );

if ( $quiz_attempts ) {
    $filename = 'quiz_attempts.csv';
    $csv_data = "User ID,Quiz ID,Attempt Date,Score\n";

    // Generate CSV data
    foreach ( $quiz_attempts as $attempt ) {
        $csv_data .= "{$attempt->user_id},{$attempt->quiz_id},{$attempt->attempt_date},{$attempt->score}\n";
    }

    // Set headers for file download
    header( 'Content-Type: text/csv' );
    header( 'Content-Disposition: attachment; filename=' . $filename );

    // Output CSV data
    echo $csv_data;

    // Terminate script execution
    exit;
}
